<!DOCTYPE HTML>
<html>
<head>
  <style>
    body {
      font-family: 'Google Sans',Arial,sans-serif;
      margin: 0;
      display: block;
    }
    button {
      font-size: 11pt;
      background-color: #1a73e8;
      border:none;
      padding: 14px 25px;
      display: inline-block;
      border-radius: 5px;
      color:white;
    }
    div{
      display: block;
    }
    .color-picker-container {
        position: absolute;
        top: 48px;
        right: 8px;
        bottom: 0;
        left: 8px;
        overflow-y: auto;
    }
    .model_header{
      font-size: 22px;
      color: #202124;
      margin-left: 20px;
      word-break: break-word;
      line-height: 1.33;
      max-height: 2.66em;
      margin-top: 3px;
      overflow: hidden;
      font-weight: medium;
    }
    .color-name {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    .color-item {
        display: flex;
        align-items: center;
        padding: 12px 16px 12px 16px;
        font-size: 14px;
        line-height: 28px;
    }
    .color-picker-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
    }
    .color-picker-title {
      font-family: Roboto,Arial,sans-serif;
      font-size: 15px;
      line-height: 18px;
      margin-left: 66px;
      padding: 20px 0 10px 0;
    }
    .color-row {
      display: flex;
      align-items: center;
      padding: 12px 16px 12px 16px;
      font-size: 14px;
      line-height: 28px;
    }
    .modal {
      overflow: hidden;
      transition: height .3s ease-in-out;
      border-radius: 8px;
      box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15), 0 1px 2px 0 rgba(60,64,67,0.3);
      height: 200px;
      margin: 4px;
    }
    .modal-close-button {
      position: absolute;
      left: 27px;
      top: 19px;
      background-color: white;
      width: 24px;
      height: 24px;
    }
    .materialdesignWizIconSvgsSvgIcon {
      position: relative;
      left: 0;
      top: 0;
    }
    .color-button{
      border: 1px solid #ccc;
      border-radius: 24px;
      height: 24px;
      width: 24px;
      min-width: 24px;
      margin-right: 16px;
      background: linear-gradient(180deg,rgba(34,34,34,0.64) 10%,rgba(69,69,69,0.33) 44%,rgba(209,209,209,0.35) 57%,rgba(253,253,253,0.6) 67%,rgba(193,193,193,0.11) 83%,rgba(31,31,31,0.38) 94%);
    }
    .hdri-button{
      border: 1px solid #ccc;
      border-radius: 24px;
      height: 24px;
      width: 24px;
      min-width: 24px;
      margin-right: 16px;
      background: #fff;
    }
    .carousel {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      width: 100%;
      height: 100%;
      padding: 2px 0 0 16px;
    }
    .carousel-frame {
        overflow: hidden;
        transition: height .3s ease-in-out;
        border-radius: 8px;
        box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15), 0 1px 2px 0 rgba(60,64,67,0.3);
        height: 184px;
        padding: 0 0 16px 0;
        margin: 4px;
    }
    .carousel-title {
        font-family: Roboto,Arial,sans-serif;
        font-weight: medium;
        font-size: 11px;
        line-height: 16px;
        letter-spacing: 0.8px;
        color: #000;
        text-transform: uppercase;
        margin: 16px 0 16px 16px;
    }
    .carousel-item>img {
        max-width: 108px;
        max-height: 82px;
        width: auto;
        height: auto;
        margin: 12px auto;
    }
    .carousel-item {
        position: relative;
        background-color: #fff;
        border-radius: 8px;
        height: 132px;
        width: 132px;
        margin: 0 4px 0 4px;
        padding: 0 12px 10px 12px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
        box-sizing: border-box;
        box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15), 0 1px 2px 0 rgba(60,64,67,0.3);
    }
    .bg-carousel-item>img {
        max-width: 135px;
        max-height: 100px;
        width: auto;
        height: auto;
        margin: 0;
    }
    .bg-carousel-item {
        position: relative;
        background-color: #fff;
        border-radius: 8px;
        height: 132px;
        width: 132px;
        margin: 0 4px 0 4px;
        padding: 0 0 10px 0;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        overflow: hidden;
        box-sizing: border-box;
        box-shadow: 0 1px 3px 1px rgba(60,64,67,0.15), 0 1px 2px 0 rgba(60,64,67,0.3);
    }
    .bg-carousel-item-info {
        color: #7f868c;
        font-size: 12px;
        padding: 0 0 0 12px;
    }
    .selected {
        border-bottom: 4px solid #1a73e8;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    .bg-selected {
        border-bottom: 4px solid #1a73e8;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
    }
    .color-selected {
        background-color: #f5f9ff;
    }
    .carousel-item-info {
        color: #7f868c;
        font-size: 12px;
    }
    .carousel-item-title {
        font-family: Roboto,Arial,sans-serif;
        color: #000;
        font-size: 12px;
        line-height: 16px;
        max-height: 32px;
        letter-spacing: 0.3px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
  </style>
</head>
<body>
<div class="carousel-frame" style="display:all;" id="carousel">
  <div class="carousel-title" id="test">(V6) Vehicle shown with options using visual effects. \n F SPORT model shown. Additional styles available.</div>
</div>
<div id="bg-picker" class="modal" style="display:none;">
  <div class="color-picker-wrapper">
      <div class="modal-close-button" id="close-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" focusable="false" class="materialdesignWizIconSvgsSvgIcon">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path>
        </svg>
      </div>
      <div class="color-picker-title">Change Background</div>
      <div class="carousel-scroll">
        <div class="carousel">
          <div class="bg-carousel-item" id="studio-btn">
            <img src="https://www.gstatic.com/ar/core/viewer/carousel/cloud9/studio_bg.png" alt="Studio background">
            <div class="bg-carousel-item-info">
              <div class="carousel-item-title">Studio</div>
            </div>
          </div>
          <div class="bg-carousel-item" id="city-park-btn">
            <img src="https://www.gstatic.com/ar/core/viewer/carousel/cloud9/city_park_bg.png" alt="City Park background">
            <div class="bg-carousel-item-info">
              <div class="carousel-item-title">City Park</div>
            </div>
          </div>
          <div class="bg-carousel-item" id="highway-btn">
            <img src="https://www.gstatic.com/ar/core/viewer/carousel/cloud9/highway_bg.png" alt="Scenic Highway background">
            <div class="bg-carousel-item-info">
              <div class="carousel-item-title">Scenic Highway</div>
            </div>
          </div>
          <div class="bg-carousel-item" id="quarry-btn">
            <img src="https://www.gstatic.com/ar/core/viewer/carousel/cloud9/outdoors_bg.png" alt="Quarry Sunset background">
            <div class="bg-carousel-item-info">
              <div class="carousel-item-title">Quarry Sunset</div>
            </div>
          </div>
          <div class="bg-carousel-item" id="rooftop-btn">
            <img src="https://www.gstatic.com/ar/core/viewer/carousel/cloud9/rooftop_bg.png" alt="Rooftop Garage background">
            <div class="bg-carousel-item-info">
              <div class="carousel-item-title" id="test">Rooftop Garage</div>
            </div>
          </div>
        </div>
    </div>
  </div>
</div>
<div id="color-picker" hidden class="modal" style="display:none;">
  <div class="color-picker-wrapper">
      <div class="modal-close-button" id="close-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" focusable="false" class="materialdesignWizIconSvgsSvgIcon">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"></path>
        </svg>
      </div>
      <div class="color-picker-title">Available Colors</div>
      <div id="color-pickers"></div>
  </div>
</div>
<script>
const cars = {
  'HchdKUvTStirvyHw7HDPBvN': [
    '2020 Lexus UX',
    [
      'Atomic Boops',
      '67625D',
      'Autumn Shimmer',
      '3B1F10',
      'Cadmium Orange',
      '6E2715',
      'Caviar',
      '1A1A1F',
      'Eminent White Pearl',
      'D7D4CC',
      'Nebula Gray Pearl',
      '3C3D3E',
      'Nori Green Pearl',
      '1F2E1E',
      'Obsidian',
      '000000',
      'Redline',
      '740417',
      'Silver Lining Metallic',
      'A6ADAF',
      'Ultra White',
      'EAEEF2',
      'Ultrasonic Blue Mica 2.0',
      '182844'
    ]
  ]
};
</script>

<script>
  const titlePrefix = "DEBUG: ";
  console.log("XXX Loading SceneViewerWeb");
  var viewerReadyEventRecieved = false;
  window.addEventListener("viewerready",async () => {
    // TODO(b/165333429) should be removed when the bug is fixed
    if (viewerReadyEventRecieved) {
      return;
    }
    viewerReadyEventRecieved = true;
    
    console.log("XXX Received viewerready async event.");

    viewer = new SceneViewerWeb();
    await viewer.setBottomCardVisibility(BottomCardVisibility.PEEKING);
    await viewer.configureButton(ButtonType.RIGHT,
                                 "https://www.gstatic.com/search-ar-dev/colour-picker-button.png",
                                 160);
    await viewer.configureButton(ButtonType.LEFT,
                                 "https://www.gstatic.com/ar/core/viewer/carousel/cloud9/bkg-button.png",
                                 160);

    //Get URL param
    function getUrlParameter(name) {
      name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
      var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
      var results = regex.exec(location.search);
      return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };

    // Convert a hex color string to an object of colors in [0, 255]
    function hexToRgb(hex) {
      // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
      var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
      hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
      });

      var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function componentToHex(c) {
      const hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
    }
    // Convert an object of integer color in [0, 255] to an a hex color string
    function rgbToHex(rgb) {
      return componentToHex(rgb.r) + componentToHex(rgb.g) + componentToHex(rgb.b);
    }

    // Correct color with linear model for all channels (source model is at go/c9-oem-colors)
    function correctComponent(c) {
      const m = 1.306816975;
      const b = 0.05658936024;
      return Math.trunc(Math.min(Math.max(c / 255 * m + b, 0.0), 1.0) * 255);
    }
    // Correct color with linear model
    function correctColor(rgb) {
      return {
        r: correctComponent(rgb.r),
        g: correctComponent(rgb.g),
        b: correctComponent(rgb.b)
      };
    }

    // Default asset state
    let assetState = {
      map: '',
      color: '',
      bg: 'studio-btn'
    };
    const carousel           = document.getElementById('carousel');
    const colorPicker        = document.getElementById('color-picker');
    const bgPicker           = document.getElementById('bg-picker');
    const carColorContainers = document.getElementsByClassName("color-picker-container");
    function hideAllCards() {
        bgPicker.style = 'display:none;';
        colorPicker.style = 'display:none;';
        carousel.style = 'display:all;';
    }
    // Close buttons
    const closeButtons = document.querySelectorAll('.modal-close-button,.color-picker-title');
    for (var i = 0; i < closeButtons.length; i++) {
      closeButtons[i].addEventListener('click', function() {
        viewer.setBottomCardVisibility(BottomCardVisibility.PEEKING);
        hideAllCards();
      });
    }
    function hideColorsContainers() {
      for (var i = 0; i < carColorContainers.length; i++) {
        carColorContainers[i].style = 'display:none;';
      }
    }
    // Interactions
    const buttonsToElements =
          [{button: ButtonType.RIGHT, element: colorPicker},
           {button: ButtonType.LEFT, element: bgPicker}];
    async function buttonPress(event) {
      if (hotspotSelected) {
        return;
      }
      hideAllCards();
      for (const buttonToElement of buttonsToElements) {
        if (buttonToElement.button === event.buttonId) {
          await viewer.setBottomCardVisibility(BottomCardVisibility.EXPANDED);
          buttonToElement.element.style = 'display:all;';
          carousel.style = 'display:none;';
        }
      }
    }
    viewer.addEventListener('buttonpress', buttonPress);
    function clickItemWithId(elementId) {
      const elem = document.getElementById(elementId);
      if(!elem)
        return;
      elem.click();
    }
    function changeMapOnClick(carIdx, mapName, title, colorIdx) {
      const btnId = "btn-" + carIdx;

      const btn = document.getElementById(btnId);
      const colorsContainer = document.getElementById("color-picker-" + carIdx);
      if(!btn || !colorsContainer)
        return;
      btn.addEventListener('click', async () => {
        viewer.sendScriptingEvent('map_switch', mapName);
        clickItemWithId("color-" + carIdx + "-" + colorIdx);
        viewer.setTitle(titlePrefix + title);
        // Display different color menus per car
        hideColorsContainers();
        colorsContainer.style = 'display:all;';
        assetState.map = btnId;
      });
    }
    function sendMessageOnClick(elementId, type, value) {
      const elem = document.getElementById(elementId);
      if(!elem)
        return;
      elem.addEventListener('click', async () => {
        viewer.sendScriptingEvent(type, value);
        if(type == "color_switch") {
          assetState.color = elementId;
        }
        if(type == "bg_switch") {
          assetState.bg = elementId;
        }
      });
    }
    // Selection highlight
    function selectionHighlight(element_id, selected_class) {
      var maps = document.getElementsByClassName(element_id);
      if(!maps)
        return;
      for (var i = 0; i < maps.length; i++) {
        maps[i].addEventListener('click', function() {
          var current = document.getElementsByClassName(selected_class);
          if (current.length > 0) {
           current[0].className = current[0].className.replace(' ' + selected_class, '');
          }
          this.className += ' ' + selected_class;
        });
      }
    }

    let carGlbMapping = {};

    // Generate random carousel content
    const carKeys = Object.keys(cars);

    let selectedCars = {};
    const file = getUrlParameter('file');
    const selectedGlbKey = file.replace('https://storage.googleapis.com/search-ar-vehicles/','').replace('.glb', '');

    // Add car to list if it does not exits
    if(!(selectedGlbKey in cars)) {
      const title = getUrlParameter('title');
      // cars[selectedGlbKey] = [title, defaultColors, true];
    }
    selectedCars[selectedGlbKey] = cars[selectedGlbKey];

    // Add all Tier-2 cars to carousel
    const tier2Cars = ['Volvo_XC40_Recharge', 'Volvo_XC40', 'Volvo_XC60', 'Volvo_XC90',
                       'Porsche_Taycan_TurboS', 'Porsche_Panamera_4SEHybrid', 'Porsche_Macan_GTS',
                       'Porsche_911_CarreraS', 'Porsche_Cayenne_TurboSEHybrid'];
    tier2Cars.forEach((tier2Car) => {
      if(tier2Car in cars)
        selectedCars[tier2Car] = cars[tier2Car];
    });

    if(getUrlParameter('carouselType') == "random") {
      let insertTriesLeft = 50;
      while(Object.keys(selectedCars).length < 5) {
        if(--insertTriesLeft <= 0)
          break;

        const selectedKey = carKeys[Math.floor(Math.random() * carKeys.length)];
        if(selectedKey in selectedCars)
          continue;
        selectedCars[selectedKey] = cars[selectedKey];
      }
    }

    let carouselTiles = selectedCars;
    if(getUrlParameter('carouselType') == "all")
      carouselTiles = cars;

//     // Overwrite car colors with Porsche test colors if they should be used
//     if(usePorscheTestColors) {
//       for (const [glb, values] of Object.entries(carouselTiles)) {
//         values[1] = porscheTestColors;
//       }
//     }

//     // Add corrected colors
//     for (const [glb, values] of Object.entries(carouselTiles)) {
//       let correctedColors = [];
//       for(let i = 0; i < values[1].length; i += 2) {
//         const name  = values[1][i + 0];
//         const color = values[1][i + 1];

//         correctedColors.push(name);
//         correctedColors.push(color);

//         const rgb = hexToRgb(color);
//         if(rgb != null) {
//           correctedColors.push(name + " (Corrected)");
//           correctedColors.push(rgbToHex(correctColor(rgb)));
//         }
//       }
//       values[1] = correctedColors;
//     }

    // Setup carousel
//     {
//       // Create carousel content from intent array
//       let carouselContent = "";
//       let colorContent = "";
//       for (const [glb, values] of Object.entries(carouselTiles)) {
//         const title = values[0];
//         const isCustomMap = values[2] === true;

//         const buttonId = "btn-" + glb;
//         const colorId = "color-" + glb;

//         const thumbnailUri = isCustomMap ?
//               'https://www.gstatic.com/ar/core/viewer/carousel/cloud9/XC90.png' :
//               `https://storage.googleapis.com/search-ar-vehicles/${glb}.png`;

//         carouselContent += `
//          <div class="carousel-item" id="${buttonId}">
//            <img src="${thumbnailUri}" alt="${title}">
//            <div class="carousel-item-info">
//              <div class="carousel-item-title">${title}</div>
//            </div>
//          </div>`;

//         colorContent += `<div class="color-picker-container"
//                               style="display: none;" id="color-picker-${glb}">`;
//         const carColors = values[1];
//         const colorCount = carColors.length / 2;
//         for(let colorIdx = 0; colorIdx < colorCount; colorIdx += 1) {
//           colorContent += `
//                 <div class="color-item" id="${colorId}-${colorIdx}">
//                 <div class="color-button"
//                      style="background-color:#${carColors[colorIdx * 2 + 1]};"></div>
//                   <span class="color-name">${carColors[colorIdx * 2]}</span>
//                 </div>`;
//         }
//         colorContent += "</div>";

//         // Store mapping from GLB URL to details for initial highlight of selected car
//         carGlbMapping[glb] = [buttonId, colorId + "-0"];
//       }
//       document.getElementById('carousel-container').innerHTML = carouselContent;
//       document.getElementById('color-pickers').innerHTML = colorContent;

//       // Set up listeners for car and color buttons
//       for (const [glb, values] of Object.entries(carouselTiles)) {
//         const title = values[0];
//         const isCustomMap = values[2] === true;

//         let glbUri = isCustomMap ?
//           glb :
//           `https://storage.googleapis.com/search-ar-vehicles/${glb}.glb`;
//         changeMapOnClick(glb, glbUri, title, 0);

//         const carColors = values[1];
//         const colorCount = carColors.length / 2;
//         for(let colorIdx = 0; colorIdx < colorCount; colorIdx += 1) {
//           const colorName =    carColors[colorIdx * 2 + 0];
//           const rgb = hexToRgb(carColors[colorIdx * 2 + 1]);
//           if(rgb == null) {
//             console.error("Failed to parse color", carColors[colorIdx * 2 + 1]);
//             continue;
//           }
//           sendMessageOnClick(`color-${glb}-${colorIdx}`,
//                              'color_switch',
//                              `(R=${rgb.r / 255},G=${rgb.g / 255},B=${rgb.b / 255},A=1)`);
//           sendMessageOnClick(`color-${glb}-${colorIdx}`,
//                              'color_name_switch', colorName);
//         }
//      }
    }

    // Selection highlight
    selectionHighlight('bg-carousel-item', 'bg-selected');
    selectionHighlight('carousel-item', 'selected');
    selectionHighlight('color-item', 'color-selected');

    // Backgrounds
    sendMessageOnClick('ar-btn', 'bg_switch', 'AR_BG');
    sendMessageOnClick('studio-btn', 'bg_switch', 'ShowroomStudio_BG');
    sendMessageOnClick('city-park-btn', 'bg_switch', 'CityPark_BG');
    sendMessageOnClick('highway-btn', 'bg_switch', 'Highway_BG');
    sendMessageOnClick('quarry-btn', 'bg_switch', 'Outdoors_BG');
    sendMessageOnClick('rooftop-btn', 'bg_switch', 'Rooftop_BG');

    // Handle change view mode events
    await viewer.addEventListener('changeviewmode', async (event) => {
      hideAllCards();
      if(event.viewModeId == ViewMode.THREE_D_MODE) {
        // Hide AR background button
        document.getElementById('ar-btn').style = 'display: none;';
        // Show background selection button
        viewer.setButtonVisibility(ButtonType.LEFT, ButtonVisibility.VISIBLE);
        // Select the Studio background as default in 3D mode
        assetState.bg = 'studio-btn';
      }
      if(event.viewModeId == ViewMode.AR_MODE) {
        // Show AR background button
        document.getElementById('ar-btn').style = 'display: all;';
        // Hide background selection button
        viewer.setButtonVisibility(ButtonType.LEFT, ButtonVisibility.HIDDEN);
        // Set AR background as default in AR mode
        assetState.bg = 'ar-btn';
      }
      // Set state for map
      // Store selected car color, as changing car will also change the color
      const carColor = assetState.color;
      clickItemWithId(assetState.map);
      if (assetState.color != carColor) {
        // Setting the car will change the color to default. We should restore to previous selected
        // color if it is different
        clickItemWithId(carColor);
      }
      clickItemWithId(assetState.bg);
    });

    // Check if car exists in C9
    if(selectedGlbKey in carGlbMapping) {
      const selectedCar = carGlbMapping[selectedGlbKey];
      assetState.map = selectedCar[0];
      assetState.color = selectedCar[1];

      // No need to call clickItemWithId here since we will call when changeviewmode is received.
      // Native only sends changeviewmode after webview is loaded and js_state_change is sent
    } else {
      viewer.setTitle('Error: Car model not found');
    }
    console.log("SceneViewerWeb ready!");

    // Send js ready event to notify the stream controller that the webpage is ready.
    viewer.sendScriptingEvent('js_state_change', 'ready');

    // Initialize left and right button state
    viewer.setButtonVisibility(ButtonType.RIGHT, ButtonVisibility.VISIBLE);
    viewer.configureButton(ButtonType.LEFT,
                           "https://www.gstatic.com/ar/core/viewer/carousel/cloud9/bkg-button.png",
                           160);
    viewer.setButtonVisibility(ButtonType.LEFT, ButtonVisibility.VISIBLE);
    viewer.setBottomCardVisibility(BottomCardVisibility.EXPANDED);
</script>
</body>
</html>
